## ç®€ä»‹

æœ¬ç¯‡æ–‡ç« æ˜¯`å•†åŸå®è·µç³»åˆ—`çš„ç¬¬äºŒç¯‡æ–‡ç« ï¼Œä¸»è¦å†…å®¹æ˜¯å¯¹å•†åŸé¡¹ç›®ä¸­ä¸€äº›`é•¿åˆ—è¡¨æ¸²æŸ“`è¿›è¡Œä¼˜åŒ–ï¼Œæé«˜æ¸²æŸ“çš„æ•ˆç‡ã€ä¼˜åŒ–æ˜¾ç¤ºé€Ÿåº¦ã€‚

æˆ‘ä»¬åœ¨ä½¿ç”¨ç”µå•†å¹³å°çš„è¿‡ç¨‹ä¸­ï¼Œæ‰“å¼€é¦–é¡µæ—¶ï¼Œæˆ‘ä»¬ä¸€ç›´å‘ä¸‹æ»‘åŠ¨å°±ä¼šæœ‰æºæºä¸æ–­çš„æ¨èå†…å®¹å‘æˆ‘ä»¬å±•ç¤ºã€‚éšç€æµè§ˆé¡µé¢æ“ä½œè¶Šæ¥è¶Šå¤šï¼Œæ•°æ®ä¹Ÿè¶Šæ¥è¶Šåºå¤§ï¼Œè¿™ç±»åœºæ™¯æˆ‘ä»¬éƒ½å¯ä»¥ç»Ÿä¸€ç§°ä¸ºé•¿åˆ—è¡¨æ¸²æŸ“ã€‚

åœ¨å•†åŸé¡¹ç›®å½“ä¸­ï¼Œé•¿åˆ—è¡¨æ¸²æŸ“å‡ºç°çš„é¡µé¢éƒ½ä¸ç”¨æˆ·å¯†åˆ‡ç›¸å…³ï¼Œå¦‚`è®¢å•åˆ—è¡¨`ã€`ä¼˜æƒ åˆ¸åˆ—è¡¨`ã€`è´­ç‰©è½¦`ç­‰éƒ½æ˜¯æˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­ç»å¸¸æµè§ˆçš„ä¸€äº›é¡µé¢ï¼Œå› æ­¤é•¿åˆ—è¡¨æ¸²æŸ“çš„`æ€§èƒ½æ•ˆç‡`ä¸`ç”¨æˆ·ä½“éªŒ`ä¸¤è€…æ˜¯æˆ`æ­£æ¯”`çš„ã€‚



![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d072876ea5494132927c0539b29b42fc~tplv-k3u1fbpfcp-watermark.awebp)

è€Œåœ¨é•¿åˆ—è¡¨é¡µé¢åšæ€§èƒ½ä¼˜åŒ–å’Œå¼€å‘è®¾è®¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¤§å¤šæ•°ä¼šç¢°åˆ°ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼š

- `æ•°æ®è¿‡å¤š`ï¼Œé¦–æ¬¡å±•ç¤ºå†…å®¹æ—¶é—´è¿‡é•¿ï¼Œæ¥å£è¿”å›æ•°æ®è¿‡å¤šï¼Œé¡µé¢æ•°æ®ä¸å¥½å¤„ç†ã€‚
- `DOMå…ƒç´ è¿‡å¤š`ï¼Œé¡µé¢æ¸²æŸ“å¡é¡¿ã€æ“ä½œä¸æµç•…ï¼Œæµè§ˆå™¨æ€§èƒ½å‹åŠ›é‡ã€‚

è¿™äº›é—®é¢˜è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿæˆ‘å»ºè®®ä½¿ç”¨åˆ†é¡µåŠ è½½+è™šæ‹Ÿåˆ—è¡¨çš„æ–¹æ¡ˆã€‚

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6772d315449f4f96b19a48cc85d280bf~tplv-k3u1fbpfcp-watermark.awebp)



## ä¸ºä»€ä¹ˆä½¿ç”¨åˆ†é¡µ+è™šæ‹Ÿåˆ—è¡¨çš„æ–¹æ¡ˆï¼Ÿ

ä¸ºäº†æ–¹ä¾¿å¤§å®¶æŸ¥é˜…ï¼Œæˆ‘æŠŠ`è¯¦ç»†çš„åœºæ™¯`ã€`é—®é¢˜å’Œå¯ç”¨çš„è§£å†³æ–¹æ¡ˆ`æ•´ç†åœ¨äº†æ€ç»´å¯¼å›¾ä¸­ã€‚å…¶ä¸­ï¼Œå¯ç”¨çš„è§£å†³æ–¹æ¡ˆåŒ…æ‹¬`åˆ†é¡µåŠ è½½`ã€`åˆ‡ç‰‡åŠ è½½`ã€`è™šæ‹Ÿåˆ—è¡¨`ï¼Œä»¥åŠ`åˆ†é¡µ+è™šæ‹Ÿåˆ—è¡¨`ã€‚é‚£ä¹ˆï¼Œæˆ‘ä¸ºä»€ä¹ˆé€‰æ‹©`åˆ†é¡µ+è™šæ‹Ÿåˆ—è¡¨`è¿™ä¸ªæ–¹æ¡ˆå‘¢ï¼Ÿ

é¦–å…ˆï¼Œæˆ‘ä»¬å°†æ¯ä¸ªæ–¹æ¡ˆå¯ä»¥`è§£å†³çš„é—®é¢˜`å’Œ`ä¸èƒ½è§£å†³çš„é—®é¢˜`åšä¸€ä¸ªæ¢³ç†ï¼Œå…·ä½“çš„ä¼˜ç¼ºç‚¹å¦‚ä¸‹ï¼š

- **åˆ†é¡µåŠ è½½**ï¼šè§£å†³äº†æ•°æ®è¿‡å¤šé—®é¢˜ï¼Œé€šè¿‡æ•°æ®åˆ†é¡µçš„æ–¹å¼å‡å°‘äº†`é¦–æ¬¡é¡µé¢åŠ è½½çš„æ•°æ®å’ŒDOMæ•°é‡`ã€‚æ˜¯ç°ä»Šç»å¤§éƒ¨åˆ†çš„åº”ç”¨éƒ½ä¼šé‡‡ç”¨çš„å®æ–½æ‰‹æ®µã€‚éšç€é¡µé¢`æµè§ˆçš„é¡µé¢æ•°æ®å¢å¤š`ï¼ŒDOMæ•°é‡ä¹Ÿè¶Šæ¥è¶Šå¤šï¼Œè¿˜æ˜¯ä¼šå­˜åœ¨éƒ¨åˆ†é—®é¢˜ã€‚
- **åˆ†ç‰‡åŠ è½½**ï¼šä¸åˆ†é¡µåŠ è½½ç›¸åŒï¼Œåªæ˜¯å°†ç”¨æˆ·è§¦åº•è¡Œä¸ºè·å–æœ€æ–°æ•°æ®çš„æ—¶é—´èŠ‚ç‚¹åœ¨ä¸€å¼€å§‹è¿›è¡Œäº†åˆ‡ç‰‡åŠ è½½ï¼Œä¼˜å…ˆæ˜¾ç¤ºé¡µé¢æ•°æ®åœ¨åŠ è½½å…¶ä»–æ•°æ®ã€‚`ä¼šå‡ºç°é¡µé¢é˜»å¡å’Œæ€§èƒ½é—®é¢˜`ã€‚
- **è™šæ‹Ÿåˆ—è¡¨**ï¼šå°†é©±åŠ¨äº¤ç»™æ•°æ®ï¼Œé€šè¿‡åŒºé—´æ¥ç›´æ¥`æ¸²æŸ“åŒºé—´å†…å®¹ä¸­çš„æ•°æ®DOM`ï¼Œè§£å†³äº†é¡µé¢åˆ—è¡¨å†…å…ƒç´ è¿‡å¤šæ“ä½œå¡é¡¿çš„é—®é¢˜, ä¸æ•°æ®åŠ è½½æ— æŒ‚é’©ã€‚

å½“åˆ—ä¸¾äº†`ä¸‰ç§å¸¸è§`çš„æ–¹å¼åï¼Œæˆ‘ä»¬å‘ç°`å•ä¸€çš„æ–¹æ¡ˆ`å¾ˆéš¾æ»¡è¶³æˆ‘ä»¬çš„è¯‰æ±‚ã€‚å› æ­¤ï¼Œæˆ‘é€‰æ‹©ä½¿ç”¨`åˆ†é¡µçš„æ–¹å¼`å¤„ç†æ•°æ®åŠ è½½ï¼ŒåŒæ—¶å°†æ¸²æŸ“é¡µé¢çš„äº‹æƒ…äº¤ç»™`è™šæ‹Ÿåˆ—è¡¨`è¿›è¡Œæ¸²æŸ“ã€‚é€šè¿‡ç»“åˆä¸¤ç§ä¸åŒä¾§é‡ç‚¹çš„æ–¹æ¡ˆï¼Œæ¥æ»¡è¶³æˆ‘ä»¬åˆæ­¥çš„è¯‰æ±‚ã€‚

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/feb2e430439d46a0b10a7cf3d85eaa3b~tplv-k3u1fbpfcp-watermark.awebp)

## å®ç°è™šæ‹Ÿåˆ—è¡¨

æ—¢ç„¶æ•²å®šäº†è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬å°±å…ˆæ¥çœ‹çœ‹è™šæ‹Ÿåˆ—è¡¨æ˜¯ä»€ä¹ˆä¸œè¥¿å§ğŸ¥³ã€‚

é€šè¿‡ä¸‹é¢çš„ç¤ºæ„å›¾ï¼Œæˆ‘ä»¬å°†æ•´ä½“åˆ—è¡¨åˆ’åˆ†ä¸º`æ»šåŠ¨çª—å£`å’Œ`å¯è§†çª—å£`ã€‚å·¦è¾¹æ˜¯çœŸå®çš„åˆ—è¡¨ï¼Œæ‰€æœ‰çš„åˆ—è¡¨é¡¹éƒ½æ˜¯çœŸå®çš„DOMå…ƒç´ ï¼Œè€Œè™šæ‹Ÿåˆ—è¡¨ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåªæœ‰å‡ºç°åœ¨å¯è§†çª—å£å†…çš„åˆ—è¡¨é¡¹æ‰æ˜¯çœŸå®çš„DOMå…ƒç´ ï¼Œè€Œæœªå‡ºç°åœ¨å¯è§†çª—å£ä¸­çš„å…ƒç´ åˆ™åªæ˜¯è™šæ‹Ÿæ•°æ®ï¼Œå¹¶æœªåŠ è½½åˆ°é¡µé¢ä¸Šã€‚

> ä¸çœŸå®åˆ—è¡¨ä¸åŒçš„æ˜¯ï¼Œè™šæ‹Ÿåˆ—è¡¨çš„æ»šåŠ¨éƒ½æ˜¯é€šè¿‡transformæˆ–è€…æ˜¯marginTopåšçš„åç§»é‡ï¼Œæœ¬èº«åˆ—è¡¨ä¸­åªæ˜¾ç¤ºè§†çª—åŒºçš„DOMå…ƒç´ ã€‚

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7a3363e976bb4e4cabf99d0414077809~tplv-k3u1fbpfcp-watermark.awebp)

ä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¥ä»0åˆ°1å®ç°ä¸€ä¸ªåŸºæœ¬çš„è™šæ‹Ÿåˆ—è¡¨å§ã€‚

### åŸºæœ¬å¸ƒå±€

å¦‚ä¸‹ç»“æ„å›¾ï¼Œæˆ‘ä»¬å…ˆåˆ†æä¸‹åŸºæœ¬é¡µé¢æ„æˆï¼š

- ç¬¬ä¸€å±‚ä¸º`å®¹å™¨å±‚`ï¼Œé€‰å®šä¸€ä¸ªå›ºå®šé«˜åº¦ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„å¯è§†åŒ–çª—å£
- ç¬¬äºŒå±‚ä¸º`å†…å®¹å±‚`ï¼Œä¸€èˆ¬åœ¨è¿™é‡Œæ’‘å¼€é«˜åº¦ï¼Œä½¿å®¹å™¨å½¢æˆ`scroll`ã€‚
- ç¬¬ä¸‰å±‚ä¸º`å­å†…å®¹å±‚`ï¼Œå±…äºå†…å®¹å±‚å†…éƒ¨ï¼Œä¹Ÿå°±æ˜¯åˆ—è¡¨ä¸­çš„åˆ—è¡¨é¡¹ã€‚
- `......`

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d484e0dd47754b2ba8ea70c42c3df4bf~tplv-k3u1fbpfcp-watermark.awebp)

åˆ†æåï¼Œæˆ‘å°†ç»“æ„å›¾ä¸­ä»£ç ä½¿ç”¨`JSX`å®ç°åï¼Œå°±æ˜¯ä¸‹é¢è¿™ä¸ªç®€å•çš„ç»“æ„ï¼š

```
é¡µé¢å¸ƒå±€ä»£ç 
<div>
  <div>
    ... List Item Element
  </div>
</div>;

.App {
    font-family: sans-serif;
    text-align: center;
}

.showElement {
    display: flex;
    justify-content: center;
    align-items: center;
    border: 1px solid #000;
    margin-bottom: 8px;
    border-radius: 4px;
}
å¤åˆ¶ä»£ç 
```

å…ˆæ­å»ºä¸€ä¸ªç®€å•çš„é¡µé¢ï¼Œç„¶åé€šè¿‡`currentViewList`æ¸²æŸ“å‡ºå¯¹åº”çš„åˆ—è¡¨é¡¹å†…å®¹ã€‚

### åˆå§‹åŒ–é¡µé¢

å½“æˆ‘ä»¬ç¡®å®šäº†é¡µé¢çš„åŸºæœ¬ç»“æ„åï¼Œæˆ‘ä»¬å†æ¥å®Œå–„ä¸€äº›å¸ƒå±€ä¸é…ç½®ï¼Œå®ç°ä¸€ä¸ªçœŸå®æ¸²æŸ“ä¸Šåƒæ¡æ•°æ®çš„åˆ—è¡¨ã€‚

æˆ‘å…ˆå®šä¹‰äº†ä¸€äº›é…ç½®ï¼ŒåŒ…å«å®¹å™¨é«˜åº¦ã€åˆ—è¡¨é¡¹é«˜åº¦ã€é¢„åŠ è½½åç§»æ•°é‡ç­‰éœ€è¦ç”¨åˆ°çš„å›ºå®šå†…å®¹ã€‚

- **å®¹å™¨é«˜åº¦**ï¼šå½“å‰è™šæ‹Ÿåˆ—è¡¨çš„é«˜åº¦
- **åˆ—è¡¨é¡¹é«˜åº¦**ï¼š åˆ—è¡¨é¡¹çš„é«˜åº¦
- **é¢„åŠ è½½åç§»**ï¼šå¯è§†çª—ä¸Šä¸‹åšé¢„åŠ è½½æ—¶éœ€è¦é¢å¤–å±•ç¤ºå‡ ä¸ªé¢„å¤‡å†…å®¹

```
é¡µé¢å±æ€§
/** @name é¡µé¢å®¹å™¨é«˜åº¦ */

const SCROLL_VIEW_HEIGHT: number = 500;

/** @name åˆ—è¡¨é¡¹é«˜åº¦ */

const ITEM_HEIGHT: number = 50;

/** @name é¢„åŠ è½½æ•°é‡ */

const PRE_LOAD_COUNT: number = SCROLL_VIEW_HEIGHT / ITEM_HEIGHT;
å¤åˆ¶ä»£ç 
```

æ¥ç€ï¼Œåˆ›å»ºä¸€ä¸ª`useRef`ç”¨æ¥å­˜å‚¨å…ƒç´ ï¼Œç„¶åè·å–è§†çª—é«˜åº¦å’Œåç§»å±æ€§ã€‚

```ts
/** å®¹å™¨Ref */

const containerRef = useRef<HTMLDivElement | null>(null);
å¤åˆ¶ä»£ç 
```

ç„¶åï¼Œåˆ›å»ºæ•°æ®æºï¼Œå¹¶ä¸”ç”Ÿæˆ`3000`æ¡éšæœºæ•°æ®åšæ˜¾ç¤ºå¤„ç†ã€‚

```ts
const [sourceData, setSourceData] = useState<number[]>([]);

/**
 * åˆ›å»ºåˆ—è¡¨æ˜¾ç¤ºæ•°æ®
 */
const createListData = () => {
  const initnalList: number[] = Array.from(Array(4000).keys());
  setSourceData(initnalList);
};

useEffect(() => {
  createListData();
}, []);
å¤åˆ¶ä»£ç 
```

æœ€åï¼Œä¸ºç›¸å¯¹åº”çš„å®¹å™¨ç»‘å®šé«˜åº¦ã€‚åœ¨æœ€å¤–å±‚divæ ‡ç­¾è®¾ç½®é«˜åº¦ä¸º`SCROLL_VIEW_HEIGHT`ï¼Œå¯¹åˆ—è¡¨divçš„é«˜åº¦åˆ™è®¾ç½®ä¸º`sourceData.length * ITEM_HEIGHT`ã€‚

```
è·å–åˆ—è¡¨æ•´ä½“é«˜åº¦
/**
 * scrollViewæ•´ä½“é«˜åº¦
 */
 const scrollViewHeight = useMemo(() => {
  return sourceData.length * ITEM_HEIGHT;
}, [sourceData]);
å¤åˆ¶ä»£ç 
ç»‘å®šé¡µé¢è§†å›¾
<div
  ref={containerRef}
  style={{
    height: SCROLL_VIEW_HEIGHT,
    overflow: "auto",
  }}
  onScroll={onContainerScroll}
>
  <div
    style={{
      width: "100%",
      height: scrollViewHeight - scrollViewOffset,
      marginTop: scrollViewOffset,
    }}
  >
    {sourceData.map((e) => (
      <div
        style={{
          height: ITEM_HEIGHT,
        }}
        className="showElement"
        key={e}
      >
        Current Position: {e}
      </div>
    ))}
  </div>
</div>;
å¤åˆ¶ä»£ç 
```

å½“æ•°æ®åˆå§‹åŒ–åï¼Œæˆ‘ä»¬çš„åˆ—è¡¨é¡µé¢å°±åˆæ­¥å®Œæˆäº†ï¼Œæ¥çœ‹ä¸‹æ•ˆæœå§ã€‚

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1d76f0c0670543aa904a53c74d5411f5~tplv-k3u1fbpfcp-watermark.awebp)

### å†…å®¹æˆªå–

å¯¹äºè™šæ‹Ÿåˆ—è¡¨æ¥è¯´ï¼Œå¹¶ä¸éœ€è¦å…¨é‡å°†æ•°æ®æ¸²æŸ“åœ¨é¡µé¢ä¸Šã€‚é‚£ä¹ˆï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å°±è¦å¼€å§‹åšæ•°æ®æˆªå–çš„å·¥ä½œäº†ã€‚

é¦–å…ˆï¼Œå¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬é€šè¿‡`showRange`æ¥æ§åˆ¶é¡µé¢æ˜¾ç¤ºå…ƒç´ çš„æ•°é‡ã€‚é€šè¿‡`Array.slice`çš„å‡½æ•°æ–¹æ³•å¯¹`sourceData`è¿›è¡Œæ•°æ®æˆªå–, è¿”å›å€¼å°±æ˜¯æˆ‘ä»¬åœ¨é¡µé¢ä¸Šå»æ˜¾ç¤ºçš„åˆ—è¡¨æ•°æ®äº†ã€‚æˆ‘å°†ä¸Šé¢ä»£ç ä¸­ç›´æ¥éå†`souceData`æ¢æˆæˆ‘ä»¬çš„æ–°æ•°æ®åˆ—è¡¨ã€‚å¦‚ä¸‹ï¼š

```ts
{currentViewList.map((e) => (
  <div
    style={{
      height: ITEM_HEIGHT
    }}
    className="showElement"
    key={e.data}
  >
    Current Position: {e.data}
  </div>
))}
å¤åˆ¶ä»£ç 
```

ä¸Šé¢ä½¿ç”¨åˆ°çš„`currentViewList`æ˜¯ä¸€ä¸ª`useMemo`çš„è¿”å›å€¼ï¼Œå®ƒä¼šéšç€`showRange`å’Œ`sourceData`çš„æ›´æ–°å‘ç”Ÿå˜åŒ–ã€‚

```ts
/**
 * å½“å‰scrollViewå±•ç¤ºåˆ—è¡¨
 */
 const currentViewList = useMemo(() => {
  return sourceData.slice(showRange.start, showRange.end).map((el, index) => ({
    data: el,
    index,
  }));
}, [showRange, sourceData]);
å¤åˆ¶ä»£ç 
```

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/08ebcff5d55a46cc9ab00cb1ced956df~tplv-k3u1fbpfcp-watermark.awebp)

### æ»šåŠ¨è®¡ç®—

è‡³æ­¤ï¼Œå·²ç»å®Œæˆäº†ä¸€ä¸ªåŸºæœ¬çš„è™šæ‹Ÿåˆ—è¡¨é›å½¢ï¼Œä¸‹ä¸€æ­¥æˆ‘ä»¬å°±éœ€è¦ç›‘å¬è§†çª—æ»šåŠ¨äº‹ä»¶æ¥è®¡ç®—`showRange`ä¸­çš„`start`å’Œ`end`çš„åç§»é‡ï¼ŒåŒæ—¶è°ƒæ•´å¯¹åº”çš„æ»šåŠ¨æ¡è¿›åº¦æ¥å®ç°ä¸€ä¸ªçœŸæ­£çš„åˆ—è¡¨æ•ˆæœã€‚

é¦–å…ˆï¼Œæˆ‘å…ˆä¸ºæ»šåŠ¨è§†çª—(scrollContainer)ç»‘å®šonScrolläº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢çš„`onContainerScroll`å‡½æ•°æ–¹æ³•ã€‚

```ts
/**
 * onScrolläº‹ä»¶å›è°ƒ
 * @param event { UIEvent<HTMLDivElement> } scrollviewæ»šåŠ¨å‚æ•°
 */
 const onContainerScroll = (event: UIEvent<HTMLDivElement>) => {
  event.preventDefault();
  calculateRange();
};
å¤åˆ¶ä»£ç 
```

åœ¨äº‹ä»¶ä¸»è¦åšçš„äº‹æƒ…å°±è®¡ç®—å½“å‰`showRange`ä¸­çš„`start`å’Œ`end`æ‰€å¤„ä½ç½®ï¼ŒåŒæ—¶æ›´æ–°é¡µé¢è§†å›¾æ•°æ®ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆå¤„ç†çš„å§ï¼

é¦–å…ˆï¼Œé€šè¿‡`containerRef.current.scrollTop`å¯ä»¥çŸ¥é“å…ƒç´ æ»šåŠ¨æ¡å†…çš„é¡¶éƒ¨éšè—åˆ—è¡¨çš„é«˜åº¦ï¼Œç„¶åä½¿ç”¨`Math.floor`æ–¹æ³•å‘ä¸‹å–æ•´åï¼Œæ¥è·å–å½“å‰åç§»çš„å…ƒç´ æ•°é‡ï¼Œåœ¨å‡å»ä¸€å¼€å§‹çš„ä¸Šä¸‹æ–‡é¢„åŠ è½½æ•°é‡`PRE_LOAD_COUNT`ï¼Œå°±å¯ä»¥å¾—å‡ºæˆªå–å†…å®¹å¼€å§‹çš„ä½ç½®ã€‚

å…¶æ¬¡ï¼Œé€šè¿‡`containerRef.current.clientHeight`å¯ä»¥è·å–æ»šåŠ¨è§†çª—çš„é«˜åº¦ï¼Œé‚£ä¹ˆé€šè¿‡`containerRef.current.clientHeight / ITEM_HEIGHT`è¿™ä¸ªå…¬å¼å°±å¯ä»¥å¾—å‡ºå½“å‰å®¹å™¨çª—å£å¯ä»¥å®¹çº³å‡ ä¸ªåˆ—è¡¨é¡¹ã€‚

å½“æˆ‘é€šè¿‡å½“å‰æ»šåŠ¨æ¡ä½ç½®ä¸‹ä¹‹å‰æ»šåŠ¨çš„å…ƒç´ ä¸ªæ•°ä¸”å·²ç»è®¡ç®—å‡ºæˆªå–çª—å£çš„èµ·å§‹ä½ç½®åï¼Œå°±å¯ä»¥é€šè¿‡`å¯åŠ¨ä½ç½® + å®¹å™¨æ˜¾ç¤ºä¸ªæ•° + é¢„åŠ è½½ä¸ªæ•°`è¿™ä¸ªå…¬å¼è®¡ç®—å‡ºäº†å½“å‰æˆªå–çª—å£çš„ç»“æŸä½ç½®ã€‚ä½¿ç”¨`setShowPageRange`æ–¹æ³•æ›´æ–°æ–°çš„ä½ç½®ä¸‹æ ‡åï¼Œå½“æˆ‘ä¸Šä¸‹æ»‘åŠ¨çª—å£ï¼Œæ˜¾ç¤ºçš„æ•°æ®ä¼šæ ¹æ®`showRange`åˆ‡å‰²æˆä¸ºä¸åŒçš„æ•°æ®æ¸²æŸ“åœ¨é¡µé¢ä¸Šã€‚

```ts
/**
 * è®¡ç®—å…ƒç´ èŒƒå›´
 */
 const calculateRange = () => {
  const element = containerRef.current;
  if (element) {
    const offset: number = Math.floor(element.scrollTop / ITEM_HEIGHT) + 1;
    console.log(offset, "offset");
    const viewItemSize: number = Math.ceil(element.clientHeight / ITEM_HEIGHT);
    const startSize: number = offset - PRE_LOAD_COUNT;
    const endSize: number = viewItemSize + offset + PRE_LOAD_COUNT;
    setShowPageRange({
      start: startSize < 0 ? 0 : startSize,
      end: endSize > sourceData.length ? sourceData.length : endSize,
    });
  }
};
å¤åˆ¶ä»£ç 
```

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dc0a4cd3562d43379357b98a0b758484~tplv-k3u1fbpfcp-watermark.awebp)

### æ»šåŠ¨æ¡åç§»

ä¸Šé¢ï¼Œæˆ‘ä»¬æåˆ°ä¼šæ ¹æ®`containerRef.current.scrollTop`è®¡ç®—å½“å‰æ»šåŠ¨è¿‡çš„é«˜åº¦ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œé¡µé¢ä¸Šå…¶å®å¹¶æ²¡æœ‰çœŸå®çš„å…ƒç´ ï¼Œåˆè¯¥å¦‚ä½•å»æ’‘å¼€è¿™ä¸ªé«˜åº¦å‘¢ï¼Ÿ

ç›®å‰è€Œè¨€ï¼Œæ¯”è¾ƒæµè¡Œçš„è§£å†³æ–¹æ¡ˆåˆ†ä¸º`MarinTop`å’Œ`TranForm`åšè·ç¦»é¡¶éƒ¨çš„åç§»æ¥å®ç°é«˜åº¦çš„æ’‘å¼€ã€‚

- marginæ˜¯å±äºå¸ƒå±€å±æ€§ï¼Œè¯¥å±æ€§çš„å˜åŒ–ä¼šå¯¼è‡´é¡µé¢çš„é‡æ’
- transformæ˜¯åˆæˆå±æ€§ï¼Œæµè§ˆå™¨ä¼šä¸ºå…ƒç´ åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å¤åˆå±‚ï¼Œå½“å…ƒç´ å†…å®¹æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œè¯¥å±‚ä¸ä¼šè¢«é‡ç»˜ï¼Œé€šè¿‡é‡æ–°å¤åˆæ¥åˆ›å»ºåŠ¨ç”»å¸§ã€‚

ä¸¤ç§æ–¹æ¡ˆå¹¶æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ï¼Œéƒ½å¯ä»¥ç”¨æ¥å®ç°è·ç¦»é¡¶éƒ¨ä½ç½®çš„åç§»ï¼Œè¾¾åˆ°æ’‘å¼€åˆ—è¡¨å®é™…é«˜åº¦çš„ä½œç”¨ã€‚

ä¸‹é¢ï¼Œæˆ‘å°±ä»¥`MarinTop`çš„æ–¹æ³•æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œæ¥å®Œå–„å½“å‰çš„è™šæ‹Ÿåˆ—è¡¨ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—å‡ºåˆ—è¡¨é¡µé¢è·ç¦»é¡¶éƒ¨çš„`MarginTop`çš„è·ç¦»ï¼Œé€šè¿‡å…¬å¼ï¼š`å½“å‰è™šæ‹Ÿåˆ—è¡¨çš„èµ·å§‹ä½ç½® * åˆ—è¡¨é¡¹é«˜åº¦`ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºå½“å‰çš„`scrollTop`è·ç¦»ã€‚

é€šè¿‡`useMemo`å°†é€»è¾‘åšä¸€ä¸ªç¼“å­˜å¤„ç†ï¼Œä¾èµ–é¡¹ä¸º`showRange.start`, å½“`showRange.start`å‘ç”Ÿå˜åŒ–æ—¶ä¼šæ›´æ–°`marginTop`çš„é«˜åº¦è®¡ç®—ã€‚

```ts
/**
 * scrollView åç§»é‡
 */
 const scrollViewOffset = useMemo(() => {
  console.log(showRange.start, "showRange.start");
  return showRange.start * ITEM_HEIGHT;
}, [showRange.start]);
å¤åˆ¶ä»£ç 
```

åœ¨é¡µé¢ä¸Šä¸ºåˆ—è¡¨çª—å£ç»‘å®š`marginTop: scrollViewOffset`å±æ€§ï¼Œå¹¶ä¸”åœ¨æ€»é«˜åº¦ä¸­å‡å»`scrollViewOffset`æ¥ç»´æŒå¹³è¡¡ï¼Œé˜²æ­¢å¤šå‡ºè·ç¦»çš„ç™½åº•ã€‚

```
å¦‚ä¸‹ä»£ç 
<div
    style={{
        width: "100%",
        height: scrollViewHeight - scrollViewOffset,
        marginTop: scrollViewOffset
    }}
>
å¤åˆ¶ä»£ç 
```

è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†ä¸€ä¸ªåŸºæœ¬çš„è™šæ‹Ÿåˆ—è¡¨ï¼Œä¸‹é¢æˆ‘ä»¬æ¥ä¸€èµ·çœ‹çœ‹å®é™…çš„æ•ˆæœå§ã€‚

![Kapture 2021-08-08 at 17.51.29.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1d3cf7f0245e4e49a86b92688b3fb33b~tplv-k3u1fbpfcp-watermark.awebp)

## ç»“åˆåˆ†é¡µåŠ è½½

å½“æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªè™šæ‹Ÿåˆ—è¡¨åï¼Œå°±å¯ä»¥å°è¯•ç»“åˆåˆ†é¡µåŠ è½½æ¥å®ç°ä¸€ä¸ªæ‡’åŠ è½½çš„é•¿è™šæ‹Ÿåˆ—è¡¨äº†ã€‚

å¦‚æœåšè¿‡åˆ†é¡µæ»šåŠ¨åŠ è½½çš„å°ä¼™ä¼´å¯èƒ½ç«‹é©¬å°±æƒ³åˆ°å®ç°æ€è·¯äº†ï¼Œä¸äº†è§£çš„åŒå­¦ä¹Ÿä¸è¦ç€æ€¥ï¼Œä¸‹é¢æˆ‘å°±å¸¦å¤§å®¶ä¸€èµ·æ¥å®ç°ä¸€ä¸ªå¸¦åˆ†é¡µåŠ è½½çš„è™šæ‹Ÿåˆ—è¡¨ï¼Œç›¸ä¿¡ä½ çœ‹å®Œä¹‹åä¼šå¯¹è¿™ç±»é—®é¢˜æœ‰ä¸€ä¸ªæ›´åŠ æ·±å…¥çš„ç†è§£ã€‚

### åˆ¤æ–­æ˜¯å¦åˆ°åº•éƒ¨

æƒ³è¦å®ç°åˆ—è¡¨çš„åˆ†é¡µåŠ è½½ï¼Œæˆ‘ä»¬éœ€è¦ç»‘å®š`onScroll`äº‹ä»¶æ¥åˆ¤æ–­å½“å‰æ»šåŠ¨è§†çª—æ˜¯å¦æ»šåŠ¨åˆ°äº†åº•éƒ¨ï¼Œå½“æ»šåŠ¨åˆ°åº•éƒ¨åéœ€è¦ä¸º`sourceData`è¿›è¡Œæ•°æ®çš„æ·»åŠ ã€‚åŒæ—¶å°†æŒªåŠ¨æŒ‡é’ˆï¼Œå°†æ•°æ®æŒ‡å‘ä¸‹ä¸€ä¸ªèµ·å§‹ç‚¹ã€‚

å…·ä½“å®ç°ä»£ç å¦‚ä¸‹ï¼Œ`reachScrollBottom`å‡½æ•°çš„è¿”å›å€¼æ˜¯å½“å‰æ»šåŠ¨çª—å£æ˜¯å¦å·²ç»åˆ°è¾¾äº†åº•éƒ¨ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é€šè¿‡å‡½æ•°çš„è¿”å›å€¼è¿›è¡Œæ¡ä»¶åˆ¤æ–­ã€‚åˆ°è¾¾åº•éƒ¨åï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿä¸€æ‰¹æ•°æ®åé€šè¿‡`setSourceData`è®¾ç½®æºæ•°æ®ã€‚ç»“æŸä¹‹ååœ¨æ‰§è¡Œ`calculateRange`é‡æ–°è®¾ç½®å†…å®¹æˆªå–çš„åŒºé—´ã€‚

```ts
/**
 * onScrolläº‹ä»¶å›è°ƒ
 * @param event { UIEvent<HTMLDivElement> } scrollviewæ»šåŠ¨å‚æ•°
 */
 const onContainerScroll = (event: UIEvent<HTMLDivElement>) => {
  event.preventDefault();
  if (reachScrollBottom()) {
    // æ¨¡æ‹Ÿæ•°æ®æ·»åŠ ï¼Œå®é™…ä¸Šæ˜¯ await å¼‚æ­¥è¯·æ±‚åšä¸ºæ•°æ®çš„æ·»åŠ 
    let endIndex = showRange.end;
    let pushData: number[] = [];
    for (let index = 0; index < 20; index++) {
      pushData.push(endIndex++);
    }
    setSourceData((arr) => {
      return [...arr, ...pushData];
    });
  }
  calculateRange();
};
å¤åˆ¶ä»£ç 
```

é‚£ä¹ˆï¼Œ`calculatScrollTop`æ˜¯å¦‚ä½•åˆ¤æ–­å½“å‰æ˜¯å¦å·²ç»è§¦åº•å‘¢ï¼Ÿ

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47ba10f8c1c84943877caccdbd5c9b33~tplv-k3u1fbpfcp-watermark.awebp)

åˆ†æä¸Šå›¾ï¼Œæˆ‘é€šè¿‡`containerRef`å¯ä»¥æ‹¿åˆ°æ»šåŠ¨çª—å£çš„é«˜åº¦`scrollHeight`æˆ–è€…ç›´æ¥ä½¿ç”¨`soureData.length * ITEM_HEIGHT`å……å½“æ»šåŠ¨çª—å£çš„é«˜åº¦ä¸¤è€…ä½œç”¨æ˜¯ä¸€æ ·çš„ã€‚

åŒæ—¶ï¼Œæˆ‘ä¹Ÿå¯ä»¥æ‹¿åˆ°`scrollTop`æ»šåŠ¨ä½ç½®è·ç¦»é¡¶éƒ¨çš„é«˜åº¦å’Œ`clientHeight`å½“å‰è§†çª—é«˜åº¦ã€‚é€šè¿‡ä¸‰è€…çš„å…³ç³»ï¼Œå¯ä»¥å¾—å‡ºæ¡ä»¶å…¬å¼ï¼š`scrollTop + clientHeight >= scrollHeight`ï¼Œæ»¡è¶³è¿™ä¸ªæ¡ä»¶å°±è¯´æ˜å½“å‰çª—å£å·²ç»åˆ°è¾¾åº•éƒ¨ã€‚æˆ‘ä»¬å°†å…¶å†™æˆ`reachScrollBottom`æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

```ts
/**
 * è®¡ç®—å½“å‰æ˜¯å¦å·²ç»åˆ°åº•åº•éƒ¨
 * @returns æ˜¯å¦åˆ°è¾¾åº•éƒ¨
 */
 const reachScrollBottom = (): boolean => {
  //æ»šåŠ¨æ¡è·ç¦»é¡¶éƒ¨
  const contentScrollTop = containerRef.current?.scrollTop || 0; 
  //å¯è§†åŒºåŸŸ
  const clientHeight = containerRef.current?.clientHeight || 0; 
  //æ»šåŠ¨æ¡å†…å®¹çš„æ€»é«˜åº¦
  const scrollHeight = containerRef.current?.scrollHeight || 0;
  if (contentScrollTop + clientHeight >= scrollHeight) {
    return true;
  }
  return false;
};
å¤åˆ¶ä»£ç 
```

### æ— é™åˆ—è¡¨æ¼”ç¤º

è‡³æ­¤ï¼Œæˆ‘ä»¬çš„è™šæ‹Ÿåˆ—è¡¨å®ç°å·²ç»åŸºæœ¬å®Œæˆäº†ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹æ•ˆæœå§ï¼Œè¿™é‡Œå…ˆç®€å•çš„æ¨¡æ‹Ÿä¸€ä¸ªå•†å“åˆ—è¡¨æ¥ä½œä¸ºæ¼”ç¤ºé¡µé¢ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š

![Kapture 2021-08-08 at 22.51.01.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0ab17038bd5e4718990bf2387bce4d85~tplv-k3u1fbpfcp-watermark.awebp)

## èµ„æºæ¨è

- [# ã€Œå‰ç«¯è¿›é˜¶ã€é«˜æ€§èƒ½æ¸²æŸ“åä¸‡æ¡æ•°æ®(è™šæ‹Ÿåˆ—è¡¨)](https://juejin.cn/post/6844903982742110216)
- [# å¦‚ä½•å®ç°ä¸€ä¸ªé«˜åº¦è‡ªé€‚åº”çš„è™šæ‹Ÿåˆ—è¡¨](https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F366416646)
- [# ahooksè™šæ‹Ÿåˆ—è¡¨](https://link.juejin.cn?target=https%3A%2F%2Fahooks.js.org%2Fhooks%2Fui%2Fuse-virtual-list)

## æ€»ç»“

æœ¬ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è®²äº†é’ˆå¯¹å•†åŸé¡¹ç›®ä¸­å‡ºç°é•¿åˆ—è¡¨çš„éƒ¨åˆ†åœºæ™¯ï¼ŒåŒæ—¶é’ˆå¯¹è¿™äº›åœºæ™¯åˆ—ä¸¾äº†ä¸åŒçš„è§£å†³æ–¹æ¡ˆåŠå…¶ä¼˜ç¼ºç‚¹ã€‚åœ¨é€‰æ‹©`åˆ†é¡µ + è™šæ‹Ÿåˆ—è¡¨`çš„ç»„åˆæ–¹å¼æ¥è§£å†³é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¸€æ­¥ä¸€æ­¥å¸¦å¤§å®¶å®ç°äº†ä¸€ä¸ªç®€å•çš„åˆ†é¡µè™šæ‹Ÿåˆ—è¡¨ï¼Œå¸®åŠ©å¤§å®¶äº†è§£å…¶å†…éƒ¨çš„åŸç†ã€‚

å½“ç„¶ï¼Œè¿™ä¸ªæ–¹æ¡ˆè¿˜æœ‰å¾ˆå¤šéœ€è¦å®Œå–„çš„åœ°æ–¹ï¼Œæˆ‘ä¹Ÿåœ¨è¿™é‡Œè¯´è¯´å®ƒéœ€è¦ä¼˜åŒ–çš„åœ°æ–¹ã€‚

- æ»šåŠ¨äº‹ä»¶å¯ä»¥æ·»åŠ èŠ‚æµäº‹ä»¶é¿å…é€ æˆæ€§èƒ½æµªè´¹ã€‚
- åˆ—è¡¨é¡¹é«˜åº¦ä¸å›ºå®šéœ€è¦ç»™å®šä¸€ä¸ªé»˜è®¤é«˜åº¦åè®¾ç½®æ–°çš„é«˜åº¦åœ¨é‡æ–°åˆ·æ–°å®¹æ˜“æˆªå–çš„å¼€å§‹å’Œç»“æŸä½ç½®ã€‚
- æ»‘åŠ¨è¿‡å¿«å‡ºç°ç™½å±é—®é¢˜å¯ä»¥å°è¯•åŠ¨æ€åŠ è½½loadingæ˜¾ç¤ºè¿‡æ¸¡ï¼Œä¼˜åŒ–ä¸€äº›ç»†èŠ‚ä½“éªŒã€‚
- åˆ—è¡¨é¡¹ä¸­å­˜åœ¨é˜´å½±å…ƒç´ éœ€è¦è€ƒè™‘ç¼“å­˜å¤„ç†ï¼Œä¸ç„¶æ»šåŠ¨æ—¶å¿…ç„¶ä¼šå¼•èµ·é‡æ–°åŠ è½½ã€‚

å¸‚é¢ä¸Šå·²ç»æœ‰å¾ˆå¤š`å¼€æºåº“`å¯ä»¥è§£å†³è¿™äº›é—®é¢˜ï¼Œå¦‚reactä¸­`ahooks`å°±æœ‰ç›¸å¯¹å®Œå–„çš„è™šæ‹Ÿåˆ—è¡¨å®è·µï¼Œæœ¬æ–‡çš„ä»£ç ç›¸å¯¹è€Œè¨€ä¹Ÿæ˜¯å¯¹å…¶çš„æºç åˆ†æã€‚

æ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬åœ¨çœŸå®å¼€å‘ä¸­å¹¶ä¸éœ€è¦ä»é›¶å¼€å§‹é€ ä¸€ä¸ªå®Œå–„çš„è½®å­ï¼Œç›´æ¥ä½¿ç”¨æˆç†Ÿçš„æ–¹æ¡ˆï¼Œæ­é…å¥½çš„äº§å“è®¾è®¡å¯ä»¥å¾ˆå¥½åœ°è§£å†³å¤§éƒ¨åˆ†çš„é—®é¢˜ã€‚

> 
